services:
  api:
    environment:
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      CELERY_BROKER_URL_FILE: /run/secrets/celery_broker_url
      CELERY_RESULT_BACKEND_FILE: /run/secrets/celery_result_backend
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      API_ADMIN_KEY_FILE: /run/secrets/api_admin_key
      API_KEYS_FILE: /run/secrets/api_keys
      SECRET_KEY_FILE: /run/secrets/secret_key
    secrets:
      - database_url
      - redis_url
      - celery_broker_url
      - celery_result_backend
      - openai_api_key
      - api_admin_key
      - api_keys
      - secret_key

  worker:
    environment:
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      CELERY_BROKER_URL_FILE: /run/secrets/celery_broker_url
      CELERY_RESULT_BACKEND_FILE: /run/secrets/celery_result_backend
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      SECRET_KEY_FILE: /run/secrets/secret_key
    secrets:
      - database_url
      - redis_url
      - celery_broker_url
      - celery_result_backend
      - openai_api_key
      - secret_key

  beat:
    environment:
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      CELERY_BROKER_URL_FILE: /run/secrets/celery_broker_url
      CELERY_RESULT_BACKEND_FILE: /run/secrets/celery_result_backend
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      SECRET_KEY_FILE: /run/secrets/secret_key
    secrets:
      - database_url
      - redis_url
      - celery_broker_url
      - celery_result_backend
      - openai_api_key
      - secret_key

  migrate:
    environment:
      DATABASE_URL_FILE: /run/secrets/database_url
      DATABASE_URL_SYNC_FILE: /run/secrets/database_url_sync
    secrets:
      - database_url
      - database_url_sync

secrets:
  database_url:
    file: ./secrets/database_url.txt
  database_url_sync:
    file: ./secrets/database_url_sync.txt
  redis_url:
    file: ./secrets/redis_url.txt
  celery_broker_url:
    file: ./secrets/celery_broker_url.txt
  celery_result_backend:
    file: ./secrets/celery_result_backend.txt
  openai_api_key:
    file: ./secrets/openai_api_key.txt
  api_admin_key:
    file: ./secrets/api_admin_key.txt
  api_keys:
    file: ./secrets/api_keys.txt
  secret_key:
    file: ./secrets/secret_key.txt
